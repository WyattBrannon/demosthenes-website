<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Demosthenes — Member Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#111827; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb; --bg:#f8fafc; --accent:#2563eb; --maxw:720px; --pad:16px; --gap:12px; }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { overflow-x:hidden; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); margin:0; background:var(--bg); }
    a { color: inherit; }
    .wrap{ min-height:100dvh; display:flex; flex-direction:column; }
    header{ padding:24px var(--pad) 10px; text-align:center; }
    .title{ font-weight:800; font-size:1.8rem; line-height:1.1; }
    .subtitle{ color:var(--muted); margin-top:6px; font-size:1rem; }
    main{ flex:1; display:flex; justify-content:center; }
    .container{ width:100%; max-width:var(--maxw); margin:0 auto; padding: 0 var(--pad) 28px; }
    .nav{ display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .btn{ display:inline-block; border:1px solid var(--border); background:#fff; border-radius:10px; padding:10px 12px; text-decoration:none; color:#111; font-weight:600; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow:0 1px 0 rgba(0,0,0,.02); }
    .stack{ display:flex; flex-direction:column; gap:var(--gap); }
    .row{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .muted{ color:var(--muted); }
    img.portrait{ width:120px; height:auto; border-radius:12px; border:1px solid var(--border); background:#fff; }
    .name{ font-size:1.35rem; font-weight:800; }
    .pill{ display:inline-block; padding:.15rem .45rem; border-radius:999px; border:1px solid var(--border); font-weight:700; margin-left:.5rem; }
    .pill.D{ background:#dbeafe; color:#1e3a8a; } .pill.R{ background:#fee2e2; color:#991b1b; } .pill.I{ background:#e5e7eb; color:#374151; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .list{ margin:0; padding-left:1.1rem; }
    .section-title{ font-weight:700; font-size:1.05rem; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width: 860px){ .grid.three{ grid-template-columns: 1fr 1fr 1fr; } }
    /* Dials */
    .dial{ display:flex; flex-direction:column; align-items:center; gap:8px; }
    .dial svg{ display:block; width:140px; height:140px; }
    .dial .label{ font-weight:700; }
    .dial .value{ font-weight:800; font-size:1.1rem; }
    /* Diagnostics */
    #dbg { font-size:.9rem; color:#991b1b; }
    #dbg code { background:#fee2e2; padding:.1rem .25rem; border-radius:.25rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Demosthenes</div>
      <div class="subtitle">Data-rich reports on your congresspeople</div>
    </header>
    <main>
      <div class="container stack">
        <nav class="nav" aria-label="Breadcrumb">
          <a class="btn" href="index.html">← Back</a>
          <span class="muted">Member report</span>
          <span id="dbg" class="muted"></span>
        </nav>

        <!-- Header -->
        <section id="headerCard" class="card">Loading…</section>

        <!-- Voting record: three dials -->
        <section class="card">
          <div class="section-title">Voting Record</div>
          <div id="dials" class="grid three"></div>
          <div class="muted" style="font-size:.9rem;">DW-NOMINATE ranges from −1 (liberal) to +1 (conservative). Party unity and vote reliability are computed from the ETL JSON.</div>
        </section>

        <!-- Signature Work (empty placeholder) -->
        <section class="card">
          <div class="section-title">Signature Work</div>
          <div class="muted">Coming soon.</div>
        </section>

        <!-- Funding Overview (empty placeholder) -->
        <section class="card">
          <div class="section-title">Funding Overview</div>
          <div class="muted">Coming soon.</div>
        </section>
      </div>
    </main>
  </div>

<script>
function qs(k){ const u=new URL(location.href); return u.searchParams.get(k) || ""; }
function pad2(n){ return String(n).padStart(2,'0'); }
function partyLetter(s){ const t=(s||'').toUpperCase(); if (t.startsWith('D') || t==='100') return 'D'; if (t.startsWith('R') || t==='200') return 'R'; return 'I'; }
function seatText(chamber, state, district){ const c=(chamber||'').toLowerCase(); return (c==='house'||c==='rep') ? `(${state||'??'}-${(district===''||district==='0'||district==null)?'AL':pad2(district)})` : `(${state||'??'})`; }
function setDbg(msg){ const el=document.getElementById('dbg'); if(el){ el.innerHTML = msg; } }

const DEFAULT_DATA_BASE = "https://WyattBrannon.github.io/demosthenes-data";
const DATA_BASE = (localStorage.getItem("DEMOS_DATA_BASE") || DEFAULT_DATA_BASE).replace(/\\/+$/,"");
const IMG_URL   = (bioguide) => DATA_BASE + "/images/" + bioguide + ".jpg";
const MEMBER_URL= (bioguide) => DATA_BASE + "/members/" + bioguide + ".json";

function renderDial(container, valuePct, centerText, label, tooltip){
  const size=140, stroke=12, r=(size/2)-stroke, C=2*Math.PI*r;
  const pct = (valuePct==null || !isFinite(valuePct)) ? 0 : Math.max(0,Math.min(100,Number(valuePct)));
  const offset = C*(1 - pct/100);
  const wrap=document.createElement('div'); wrap.className='dial'; if (tooltip) wrap.title=tooltip;
  wrap.innerHTML = `
    <svg viewBox="0 0 ${size} ${size}" role="img" aria-label="${label}: ${isFinite(valuePct)?valuePct.toFixed(1):'N/A'}%">
      <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="#e5e7eb" stroke-width="${stroke}"></circle>
      <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="#2563eb" stroke-width="${stroke}" stroke-linecap="round"
              stroke-dasharray="${C}" stroke-dashoffset="${offset}" transform="rotate(-90 ${size/2} ${size/2})"></circle>
      <text x="50%" y="48%" text-anchor="middle" font-size="16" font-weight="700">${centerText}</text>
      <text x="50%" y="66%" text-anchor="middle" font-size="12" fill="#6b7280">${isFinite(valuePct)?valuePct.toFixed(1):'N/A'}%</text>
    </svg>
    <div class="label">${label}</div>
  `;
  container.appendChild(wrap);
}

async function main(){
  const bioguide = qs('bioguide');
  const header = document.getElementById('headerCard');
  if (!bioguide){ header.textContent="Missing ?bioguide=…"; return; }

  const url = MEMBER_URL(bioguide);
  setDbg(`<code>DATA_BASE</code> = ${DATA_BASE}`);
  header.textContent = "Fetching member JSON…";

  let data = null;
  try{
    const r = await fetch(url, {cache:"no-store"});
    if (!r.ok) throw new Error("HTTP " + r.status + " for " + url);
    data = await r.json();
  }catch(e){
    header.textContent = "Failed to load member JSON.";
    setDbg("Error: " + (e && e.message || e));
    return;
  }
  if (!data || !data.identity || !data.alignment){
    header.textContent = "Invalid member JSON.";
    return;
  }

  // ---- Header render
  const id = data.identity || {};
  const party = id.party || "";
  const state = id.state || "";
  const district = id.district || null;
  const chamber = (id.district==null ? "senate" : "house"); // heuristic; ETL can add if needed
  const name = data.name && data.name.official_full ? data.name.official_full : (data.identity.display_name || data.bioguide);
  header.innerHTML = "";
  const img = new Image(); img.className="portrait"; img.alt=name||"Portrait"; img.src=IMG_URL(data.bioguide); img.onerror=()=>{ img.style.display='none'; };
  const nameEl = document.createElement('div'); nameEl.className='name'; nameEl.textContent = name;
  const pill = document.createElement('span'); pill.className='pill ' + partyLetter(party); pill.textContent = partyLetter(party);
  const seat = document.createElement('div'); seat.className='muted'; seat.textContent = (chamber==="senate"?"Senator":"Representative") + " " + seatText(chamber, state, district);
  const tenure = document.createElement('div'); tenure.className='muted mono'; tenure.textContent = `Tenure: ${id.tenure_years ?? "?"} years`;

  const commWrap = document.createElement('div'); commWrap.className='stack';
  const commTitle = document.createElement('div'); commTitle.className='section-title'; commTitle.textContent = "Committees";
  const commList = document.createElement('ul'); commList.className='list';
  const committees = Array.isArray(id.committees) ? id.committees : [];
  if (committees.length){
    committees.forEach(c => {
      const li=document.createElement('li');
      li.textContent = c.name + (c.role ? ` — ${c.role}` : "");
      commList.appendChild(li);
    });
  } else {
    const li=document.createElement('li'); li.textContent="N/A"; commList.appendChild(li);
  }
  commWrap.append(commTitle, commList);
  const row = document.createElement('div'); row.className='row';
  const right = document.createElement('div'); right.className='stack'; right.append(nameEl, pill, seat, tenure, commWrap);
  row.append(img, right);
  header.appendChild(row);

  // ---- Dials
  const dials = document.getElementById('dials');
  const al = data.alignment || {};
  // Ideology: center = raw dim1; ring = dim1 mapped to 0..100
  let dim1 = (typeof al.dw_nominate_dim1 === "number") ? al.dw_nominate_dim1 : null;
  const ideologyPct = (dim1==null) ? null : Math.max(0, Math.min(100, ((dim1 + 1)/2)*100));
  renderDial(dials, ideologyPct, (dim1!=null ? dim1.toFixed(2) : "N/A"), "Ideology (DW-NOMINATE)", "−1 liberal … +1 conservative");

  // Party unity: spec uses 0..1 -> convert to %
  const pu = (typeof al.party_unity_pct === "number") ? (al.party_unity_pct * 100) : null;
  renderDial(dials, pu, (pu!=null ? Math.round(pu).toString() : "—"), "Party Unity", "100 − (% maverick votes)");

  // Vote reliability: 1 - missed/(total+missed)
  const total = Number(al.total_votes||0);
  const missed = Number(al.missed_votes||0);
  const denom = total + missed;
  const reliability = denom ? (100 - (missed / denom) * 100) : null;
  renderDial(dials, reliability, (reliability!=null ? Math.round(reliability).toString() : "—"), "Vote Reliability", "100 − (missed / (total + missed))");
}

window.addEventListener('DOMContentLoaded', () => {
  main().catch(e => { const h=document.getElementById('headerCard'); if (h) h.textContent = "Load error: " + (e && e.message || e); });
});
</script>
</body>
</html>
