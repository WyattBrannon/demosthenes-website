<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Demosthenes — Member</title>
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
      --bg:#f8fafc; --accent:#2563eb; --danger:#b91c1c;
      --maxw: 720px; --pad: 16px; --gap: 12px;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { overflow-x:hidden; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); margin:0; background:var(--bg); }

    .wrap{min-height:100dvh; display:flex; flex-direction:column;}
    header{padding:24px var(--pad) 10px; text-align:center;}
    .title{font-weight:800; font-size:1.8rem; line-height:1.1;}
    .subtitle{color:var(--muted); margin-top:6px; font-size:1rem;}
    main{flex:1; display:flex; justify-content:center;}
    .container{width:100%; max-width:var(--maxw); margin:0 auto; padding: 0 var(--pad) 28px;}

    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
    .stack{ display:flex; flex-direction:column; gap:var(--gap); }
    .row{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .muted{ color:var(--muted); }
    .pill{ display:inline-block; padding:.15rem .45rem; border-radius:999px; border:1px solid var(--border); font-size:.8rem; color:#111; background:#f3f4f6; }
    .btn{ display:inline-block; border:1px solid var(--border); background:#fff; border-radius:10px; padding:10px 12px; text-decoration:none; color:#111; font-weight:600; }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width: 860px){
      .grid.two{ grid-template-columns: 1fr 1fr; }
    }
    img.portrait{ width:120px; height:auto; border-radius:12px; border:1px solid var(--border); background:#fff; }

    #dbgpre{background:#0b1020;color:#aee;border:1px solid var(--border);border-radius:8px;padding:8px;
      max-height:200px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; white-space:pre-wrap; display:none;}

    .section-title{ font-weight:700; font-size:1.1rem; }
    .chip{ font-weight:700; font-size:.85rem; color:#fff; border-radius:999px; padding:.2rem .5rem; }
    .chip.D{ background:#2563eb; }
    .chip.R{ background:#dc2626; }
    .chip.I{ background:#059669; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Demosthenes</div>
      <div class="subtitle">Data-rich reports on your congresspeople</div>
    </header>

    <main>
      <div class="container stack">
        <nav class="row" aria-label="Breadcrumb">
          <a class="btn" href="index.html">← Back</a>
          <span class="muted">Member report</span>
        </nav>

        <section id="memberCard" class="card"></section>

        <section class="grid two">
          <div class="card">
            <div class="section-title">Recent Activity</div>
            <div id="recentActivity" class="muted">Coming soon.</div>
          </div>
          <div class="card">
            <div class="section-title">Committees</div>
            <div id="committees" class="muted">Coming soon.</div>
          </div>
        </section>

        <section class="card">
          <div class="section-title">Sponsored & Cosponsored Bills</div>
          <div id="bills" class="muted">Coming soon.</div>
        </section>

        <section class="card">
          <div class="section-title">Debug</div>
          <pre id="dbgpre">Debug ready.</pre>
        </section>
      </div>
    </main>
  </div>

<script>
/* ===== Utilities ===== */
function d(line){ try{ const p=document.getElementById('dbgpre'); if(p){ p.style.display='block'; p.textContent += (line + "\\n"); p.scrollTop = p.scrollHeight; } console.log(line);}catch(_){ } }
function qs(k){ const u=new URL(location.href); return u.searchParams.get(k) || ""; }
function pad2(n){ return String(n).padStart(2,'0'); }
const USPS = { "AL":"Alabama","AK":"Alaska","AZ":"Arizona","AR":"Arkansas","CA":"California","CO":"Colorado","CT":"Connecticut","DE":"Delaware","DC":"District of Columbia","FL":"Florida","GA":"Georgia","HI":"Hawaii","ID":"Idaho","IL":"Illinois","IN":"Indiana","IA":"Iowa","KS":"Kansas","KY":"Kentucky","LA":"Louisiana","ME":"Maine","MD":"Maryland","MA":"Massachusetts","MI":"Michigan","MN":"Minnesota","MS":"Mississippi","MO":"Missouri","MT":"Montana","NE":"Nebraska","NV":"Nevada","NH":"New Hampshire","NJ":"New Jersey","NM":"New Mexico","NY":"New York","NC":"North Carolina","ND":"North Dakota","OH":"Ohio","OK":"Oklahoma","OR":"Oregon","PA":"Pennsylvania","RI":"Rhode Island","SC":"South Carolina","SD":"South Dakota","TN":"Tennessee","TX":"Texas","UT":"Utah","VT":"Vermont","VA":"Virginia","WA":"Washington","WV":"West Virginia","WI":"Wisconsin","WY":"Wyoming"};

/* ===== Data base & image helpers (same pattern as index) ===== */
const DEFAULT_DATA_BASE = "https://WyattBrannon.github.io/demosthenes-data";
const DATA_BASE = (localStorage.getItem("DEMOS_DATA_BASE") || DEFAULT_DATA_BASE).replace(/\\/+$/,"");
const YAML_URL = DATA_BASE + "/legislators-current.yaml";
const IMG_URL = (bioguide) => DATA_BASE + "/images/" + bioguide + ".jpg";

/* ===== Render ===== */
function renderMember(m){
  const mount = document.getElementById('memberCard');
  if (!m){ mount.innerHTML = '<div class="muted">Member not found.</div>'; return; }

  const portrait = new Image();
  portrait.className = "portrait";
  portrait.alt = (m.name || "Portrait");
  portrait.src = IMG_URL(m.bioguide);
  portrait.onerror = () => { portrait.style.display='none'; };

  const chip = (p)=>{ const c = (p||"").slice(0,1); const span=document.createElement('span'); span.className='chip ' + (c||''); span.textContent = (p||''); return span; };

  const seat = m.chamber==="sen" ? `(${m.state})`
              : `(${m.state}-${(m.district==null || m.district==="AL") ? "AL" : pad2(m.district)})`;

  const nameEl = document.createElement('div');
  nameEl.style.fontSize = '1.35rem';
  nameEl.style.fontWeight = '800';
  nameEl.textContent = m.name || "Unknown";

  const meta1 = document.createElement('div');
  meta1.className = 'muted';
  meta1.append(chip(m.party || ""));
  meta1.append(' ');
  meta1.append(`${m.chamber==="sen"?"Senator":"Representative"} ${seat}`);

  const links = document.createElement('div');
  links.className = 'row';
  if (m.urls && m.urls.length){
    const a = document.createElement('a'); a.className = 'btn'; a.href = m.urls[0]; a.textContent = 'Official site'; a.target="_blank"; a.rel="noopener";
    links.append(a);
  }
  if (m.twitter){ const a = document.createElement('a'); a.className='btn'; a.href = 'https://twitter.com/'+m.twitter; a.textContent='Twitter'; a.target="_blank"; a.rel="noopener"; links.append(a); }
  if (m.facebook){ const a = document.createElement('a'); a.className='btn'; a.href = 'https://facebook.com/'+m.facebook; a.textContent='Facebook'; a.target="_blank"; a.rel="noopener"; links.append(a); }

  const row = document.createElement('div'); row.className = 'row';
  row.append(portrait);
  const info = document.createElement('div'); info.className='stack';
  info.append(nameEl, meta1, links);

  // Term details (if available)
  if (m.term){
    const t = document.createElement('div'); t.className='muted mono';
    t.textContent = `Term: ${m.term.start || "?"} → ${m.term.end || "?"}`;
    info.append(t);
  }

  const card = document.createElement('div'); card.className='stack';
  card.append(row);
  mount.className = "card stack";
  mount.innerHTML = "";
  mount.append(card);
}

/* ===== Load one member by bioguide ===== */
async function main(){
  const bioguide = qs('bioguide');
  if (!bioguide){ renderMember(null); d("No bioguide in URL."); return; }
  d("Loading roster from " + YAML_URL);
  const r = await fetch(YAML_URL, {cache:"no-store"});
  if (!r.ok){ renderMember(null); d("HTTP " + r.status); return; }
  const text = await r.text();
  const yaml = (window.jsyaml ? jsyaml.load(text) : null) || [];
  const today = new Date().toISOString().slice(0,10);

  let found = null;
  for (const rec of yaml){
    if (rec?.id?.bioguide !== bioguide) continue;
    const terms = rec?.terms || [];
    const t = terms[terms.length-1] || {};
    const type = (t.type || "").toLowerCase();
    if (!(type==="rep" || type==="sen")) continue;
    if (t.end && t.end < today) continue; // filter out expired
    found = {
      bioguide,
      name: [rec?.name?.first, rec?.name?.middle, rec?.name?.last].filter(Boolean).join(" "),
      party: t.party || rec?.party || "",
      chamber: type,
      state: t.state,
      district: type==="rep" ? (t.district ?? "AL") : null,
      term: { start: t.start || "", end: t.end || "" },
      urls: Array.isArray(rec?.terms) ? (rec.terms.map(x=>x.url).filter(Boolean)) : [],
      twitter: rec?.social?.twitter || rec?.id?.twitter,
      facebook: rec?.social?.facebook || rec?.id?.facebook
    };
    break;
  }
  if (!found){
    d("Member not found in YAML for " + bioguide);
  }
  renderMember(found);
}

window.addEventListener('DOMContentLoaded', () => {
  main().catch(e => { d("Load error: " + (e && e.message || e)); renderMember(null); });
});
</script>
</body>
</html>
