<!doctype html>
<html lang="en">
<head>
  <!-- build: index.html · v2025-08-16-idx4 -->
  <meta charset="utf-8" />
  <title>Demosthenes — Find Your Representatives</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#111827; --muted:#6b7280; --card:#fafafa; --border:#e5e7eb; --accent:#2563eb; --warn:#b45309; --err:#b91c1c; }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { overflow-x:hidden; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); margin:0; background:#f8fafc; }
    h1 { font-size:1.9rem; margin:0 0 6px; text-align:center; }
    p.hint { color:var(--muted); margin:.25rem 0 0; text-align:center; }
    .wrap { display:grid; grid-template-columns: 1fr; gap:16px; max-width:720px; width:100%; padding:20px 16px 28px; margin:0 auto; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    input[type="text"] { padding:.6rem .8rem; font-size:1rem; border:1px solid var(--border); border-radius:8px; min-width:280px; flex:1; }
    button { padding:.6rem .9rem; font-size:1rem; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:white; border-color:var(--accent); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; width:100%; }
    .settings { font-size:.95rem; color:var(--muted); }
    .result-grid { display:grid; grid-template-columns: 1fr; gap:12px; width:100%; }
    .member { display:flex; gap:12px; align-items:flex-start; }
    img.portrait { width:72px; height:96px; object-fit:cover; border-radius:8px; border:1px solid var(--border); background:#fff; }
    a.btn { display:inline-block; margin-top:6px; text-decoration:none; color:var(--accent); }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .dim { color:var(--muted); }
    .msg { padding:8px 10px; border-radius:8px; margin-top:8px; border:1px solid var(--border); background:#fff; white-space:pre-wrap; }
    .msg.warn { border-color:#fed7aa; background:#fffbeb; color:var(--warn); }
    .msg.err  { border-color:#fecaca; background:#fef2f2; color:#991b1b; }
    details { margin-top:8px; }
    summary { cursor:pointer; }
    #debug pre { background:#fff; border:1px solid var(--border); padding:8px; border-radius:8px; overflow:auto; max-height:300px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    label.select { display:block; font-size:.95rem; color:var(--muted); }
    select { padding:.45rem .6rem; border:1px solid var(--border); border-radius:8px; font-size:1rem; width:100%; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" crossorigin="anonymous"></script>


<script>
// JSONP helper (for APIs that don't set CORS headers)
function jsonpRequest(url, paramName = 'callback', debug) {
  return new Promise((resolve, reject) => {
    const cb = 'jsonp_cb_' + Math.random().toString(36).slice(2);
    const cleanup = () => {
      try { delete window[cb]; } catch (_) {}
      if (script && script.parentNode) script.parentNode.removeChild(script);
    };
    window[cb] = function (data) {
      cleanup();
      resolve(data);
    };
    const script = document.createElement('script');
    const sep = url.includes('?') ? '&' : '?';
    script.src = url + sep + encodeURIComponent(paramName) + '=' + encodeURIComponent(cb);
    script.onerror = function () {
      cleanup();
      reject(new Error('JSONP load error'));
    };
    document.head.appendChild(script);
  });
}

// Helper to fetch congressional district from Census Geocoder using lat/lon
async function fetchCensusDistrict(lat, lon, debug) {
  const base = `https://geocoding.geo.census.gov/geocoder/geographies/coordinates`;
  const params = (bmk, vtg, layers) => (
    `?y=${encodeURIComponent(lat)}&x=${encodeURIComponent(lon)}` +
    `&benchmark=${encodeURIComponent(bmk)}` +
    `&vintage=${encodeURIComponent(vtg)}` +
    (layers ? `&layers=${encodeURIComponent(layers)}` : '') +
    `&format=json`
  );
  const urls = [
    base + params('Public_AR_Current', 'Current_Current', 'Congressional Districts'),
    base + params('Public_AR_Current', 'Current_Current', ''),
    base + params('Public_AR_Census2020', 'Current_Current', 'Congressional Districts')
  ];

  for (const url of urls) {
    try {
      debug && debug("Census GET " + url);
      // Try fetch first
      try {
        const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!r.ok) throw new Error("Census HTTP " + r.status);
        const j = await r.json();
        const d = extractDistrictFromCensus(j);
        if (d) return d;
      } catch (e) {
        debug && debug("Census fetch error: " + (e && e.message || e));
        // Try JSONP fallbacks (some Census deployments don't send CORS headers)
        try {
          debug && debug("Census JSONP GET " + url + " [callback]");
          const j = await jsonpRequest(url, 'callback', debug);
          const d = extractDistrictFromCensus(j);
          if (d) return d;
        } catch (e1) {
          debug && debug("Census JSONP (callback) failed: " + (e1 && e1.message || e1));
          try {
            debug && debug("Census JSONP GET " + url + " [jsonp]");
            const j2 = await jsonpRequest(url, 'jsonp', debug);
            const d2 = extractDistrictFromCensus(j2);
            if (d2) return d2;
          } catch (e2) {
            debug && debug("Census JSONP (jsonp) failed: " + (e2 && e2.message || e2));
          }
        }
      }
    } catch (outer) {
      debug && debug("Census error: " + (outer && outer.message || outer));
      continue;
    }
  }
  return ""; // not found
}

// Pull two-digit district code from Census Geocoder response
function extractDistrictFromCensus(j) {
  if (!j || !j.result || !j.result.geographies) return "";
  const geogs = j.result.geographies;
  let cds = geogs["Congressional Districts"];
  if (!Array.isArray(cds) || cds.length === 0) {
    for (const k of Object.keys(geogs)) {
      if (/Congressional District/i.test(k)) {
        const arr = geogs[k];
        if (Array.isArray(arr) && arr.length) { cds = arr; break; }
      }
    }
  }
  if (Array.isArray(cds) && cds.length) {
    const rec = cds[0];
    let d = "";
    if (typeof rec.BASENAME === "string") d = rec.BASENAME.trim();
    if (!/^\d{2}$/.test(d) && typeof rec.GEOID === "string") {
      const m = rec.GEOID.match(/(\d{2})$/);
      if (m) d = m[1];
    }
    if (/^\d{1,2}$/.test(d)) return d.length === 1 ? ("0" + d) : d;
    if (/^(AL|00)$/i.test(d)) return "AL";
  }
  return "";
}
</script>


</head>
<body>
  <div class="wrap">
    <header>
      <h1>Demosthenes</h1>
      <p class="hint">Data-rich reports on your congresspeople</p>
  <div class="row" style="justify-content:center; margin-top:8px">
    <a class="btn" href="about.html">About</a>
  </div>
    </header>

    <section class="card">
      <form id="searchForm" class="row">
        <input id="addr" type="text" placeholder="e.g., 1600 Pennsylvania Ave NW, Washington, DC" enterkeyhint="go">
        <button class="primary" id="go">Find my reps</button>
</form>
      <div class="settings" style="margin-top:8px;">
        
        <div class="row" style="margin-top:6px">
          <label>  </label>
          </div>
        <div id="msg" class="msg warn" style="display:none;"></div>
        <details id="debug"><summary>Debug info</summary><pre id="dbgpre"></pre></details>
      </div>
    </section>

    <section class="card">
      <!-- Name search (above manual selector) -->
      <div class="row" style="margin-bottom:8px">
        <input id="nameQuery" type="text" placeholder="Search by name (e.g., Eleanor Holmes Norton)" />
        <button class="primary" id="searchByName">Search</button>
      </div>
      <h3>Manual district selector</h3>
      <div class="grid2">
        <label class="select">State
          <select id="stateSel"></select>
        </label>
        <label class="select">District
          <select id="distSel"></select>
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="goManual">Show my reps</button>
      </div>
    </section>

    <section id="results" class="result-grid"></section>
</div>

  <script>
  window.addEventListener('error', function(e){
    const msg = document.getElementById('msg');
    if (!msg) return;
    msg.textContent = 'JS error: ' + (e.message || e.error);
    msg.className = 'msg err';
    msg.style.display = 'block';
  });

  window.addEventListener('DOMContentLoaded', function(){

    function getApiBase(){ return ""; }
    
    const DATA_BASE = "https://WyattBrannon.github.io/demosthenes-data";
    const BASE = (localStorage.getItem("DEMOS_DATA_BASE") || DATA_BASE).replace(/\/+$/,"");
    const YAML_URL = `${BASE}/legislators-current.yaml`;

    const addrEl = document.getElementById("addr");
    
    
    // Submit form on mobile "Go" / Enter
    const searchForm = document.getElementById('searchForm');
    if (searchForm) {
      searchForm.addEventListener('submit', function(e){
        e.preventDefault();
        const goBtn = document.getElementById('go');
        if (goBtn) goBtn.click();
      });
    }
// Trigger search on Enter in the address field
    addrEl.addEventListener('keydown', function(e){
      if (e.key === 'Enter') {
        e.preventDefault();
        var goBtn = document.getElementById('go');
        if (goBtn) goBtn.click();
      }
    });
const goBtn = document.getElementById("go");
    const sampleBtn = document.getElementById("useSample");
    const res = document.getElementById("results");
    const msg = document.getElementById("msg");
    const dbgpre = document.getElementById("dbgpre");

    const apiBaseInput = document.getElementById('apiBase');
    const saveApiBtn = document.getElementById('saveApi');
    const clearApiBtn = document.getElementById('clearApi');
    const apiBaseLabel = document.getElementById('apiBaseLabel');

    function setApiUI(){
      try {
        const apiBaseInput = document.getElementById('apiBase');
        const apiBaseLabel = document.getElementById('apiBaseLabel');
        const val = (typeof getApiBase === 'function' ? getApiBase() : "") || "";
        if (apiBaseInput) apiBaseInput.value = val;
        if (apiBaseLabel) apiBaseLabel.textContent = val || "";
      } catch(_) {}
    }
    setApiUI();

    function debug(line){ dbgpre.textContent += line + "\n"; }
    function showMsg(text, kind="warn"){ msg.textContent = text; msg.className = "msg " + kind; msg.style.display = 'block'; }
    function hideMsg(){ msg.style.display = 'none'; }

    function el(tag, attrs = {}, children = []){ const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>k==="class"?(n.className=v):v!=null&&n.setAttribute(k,v)); (Array.isArray(children)?children:[children]).forEach(c=>n.appendChild(typeof c==="string"?document.createTextNode(c):c)); return n; }
    function normalizeName(s){ return (s||"").toLowerCase().replace(/[^a-z\s]/g,"").replace(/\s+/g," ").trim(); }

    const todayISO = new Date().toISOString().slice(0,10);
    let CURRENT = [];
    const STATES = ["AL","AK","AZ","AR","CA","CO","CT","DE","DC","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
    const AL_STATES = new Set(["AK","DE","DC","MT","ND","SD","VT","WY"]);

    // Manual selector state
    const stateSel = document.getElementById('stateSel');
    const distSel = document.getElementById('distSel');
    const goManual = document.getElementById('goManual');

    function populateStates(){
      stateSel.innerHTML = STATES.map(s=>`<option value="${s}">${s}</option>`).join("");
    }
    function populateDistrictsFor(state){
      const maxByState = {
        "AL":7,"AK":1,"AZ":9,"AR":4,"CA":52,"CO":8,"CT":5,"DE":1,"DC":1,"FL":28,"GA":14,"HI":2,"ID":2,"IL":17,"IN":9,"IA":4,"KS":4,"KY":6,"LA":6,"ME":2,"MD":8,"MA":9,"MI":13,"MN":8,"MS":4,"MO":8,"MT":2,"NE":3,"NV":4,"NH":2,"NJ":12,"NM":3,"NY":26,"NC":14,"ND":1,"OH":15,"OK":5,"OR":6,"PA":17,"RI":2,"SC":7,"SD":1,"TN":9,"TX":38,"UT":4,"VT":1,"VA":11,"WA":10,"WV":2,"WI":8,"WY":1
      };
      const n = maxByState[state] || 1;
      const isAL = (n===1);
      distSel.innerHTML = isAL ? `<option value="AL">At-Large</option>`
                               : Array.from({length:n},(_,i)=>`<option value="${String(i+1).padStart(2,"0")}">${i+1}</option>`).join("");
    }

    populateStates();
    stateSel.value = "DC"; populateDistrictsFor("DC");
    stateSel.addEventListener('change', ()=> populateDistrictsFor(stateSel.value));

    async function loadMembers(){
      const r = await fetch(YAML_URL, {cache:"no-store"});
      if (!r.ok) throw new Error('Failed to load legislators-current.yaml ('+r.status+')');
      const text = await r.text();
      const yamlObj = jsyaml.load(text);
      CURRENT = yamlObj.map(rec=>{
        const terms=rec?.terms||[]; if(!terms.length) return null;
        const t=terms[terms.length-1]; const type=(t.type||"").toLowerCase(); const end=t.end||"";
        if (!((type==="rep"||type==="sen") && (!end || end >= todayISO))) return null;
        return {
          bioguide: rec?.id?.bioguide,
          name: [rec?.name?.first, rec?.name?.middle, rec?.name?.last].filter(Boolean).join(" "),
          state: t.state,
          district: type==="rep" ? (t.district ?? "") : "",
          chamber: type==="rep" ? "house" : "senate",
          party: t.party || (rec?.party)||"",
          norm: normalizeName([rec?.name?.first, rec?.name?.middle, rec?.name?.last].filter(Boolean).join(" "))
        };
      }).filter(Boolean);}

    
    // === Search by name ===
    function memberDisplayName(m){
      if (m.name && m.name.trim()) return m.name.trim();
      return [m.first, m.middle, m.last].filter(Boolean).join(" ").trim() || (m.bioguide||"");
    }
    function searchMembersByName(query){
      const q = normalizeName(query||"");
      if (!q) return [];
      return (Array.isArray(CURRENT)?CURRENT:[]).filter(m => {
        const nm = normalizeName(memberDisplayName(m));
        return nm.includes(q);
      });
    }

    function findMembers(where){
      const {state, district} = where;
      const senators = CURRENT.filter(m => m.chamber==="senate" && m.state===state);
      const rep = CURRENT.find(m => m.chamber==="house" && m.state===state && ((m.district===0||m.district===""||m.district==null) ? district==="AL" : String(m.district).padStart(2,"0")===district));
      const reps = [...senators];
      if (rep) reps.push(rep);
      return reps;
    }

    function renderResults(people){
      const BASE = (localStorage.getItem("DEMOS_DATA_BASE") || "https://WyattBrannon.github.io/demosthenes-data").replace(/\/+$/,"");
      res.innerHTML = "";
      if (!people.length) {
        res.appendChild(el("div",{class:"card"}, "No matches found."));
        return;
      }
      const IMG_URL_MEMBER = (bioguide) => `${BASE}/images/${bioguide}.jpg`;
      for (const p of people){
        const a = el("a",{href:`member.html?bioguide=${encodeURIComponent(p.bioguide)}`,"class":"btn"},"View report →");
        const img = el("img",{class:"portrait",src:IMG_URL_MEMBER(p.bioguide),alt:p.name});
        img.onerror = () => { img.style.visibility="hidden"; img.style.height="0"; };
        const seat = p.chamber==="senate" ? `(${p.state})` : `(${p.state}-${(p.district===0||p.district===""||p.district==null)?"AL":String(p.district).padStart(2,"0")})`;
        const card = el("div",{class:"card"},[
          el("div",{class:"member"},[
            img,
            el("div",{},[
              el("div",{},`${p.name}`),
              el("div",{class:"dim"}, `${p.chamber==="senate"?"Senator":"Representative"} ${seat}`),
              a
            ])
          ])
        ]);
        res.appendChild(card);
      }
    }

    async function callServerResolve(address){
      const apiBase = getApiBase();
      const url = apiBase.replace(/\/+$/,"") + '/resolve?address=' + encodeURIComponent(address);
      debug('API GET ' + url);
      const r = await fetch(url);
      if (!r.ok) throw new Error('API HTTP ' + r.status);
      const j = await r.json();
      if (!j || !j.state || !j.district) throw new Error('API invalid payload');
      return { state: j.state, district: j.district };
    }

    async function resolveAddress(address){
      // 1) Try user-provided server API (if configured)
      try {
        if (getApiBase()) {
          const res = await callServerResolve(address);
          debug('Resolved via API: ' + JSON.stringify(res));
          return res;
        }
      } catch (e) {
        debug('API failed: ' + e.message);
      }
      
// 2) Fallback: quick OSM geocode and simple guess (best-effort; can be wrong in multi-district states)
try {
  const NOMINATIM_EMAIL = window.NOMINATIM_EMAIL || ""; //  set e.g. "you@example.com"
  const osmParams = new URLSearchParams({
    format: "jsonv2",
    addressdetails: "1",
    limit: "1",
    q: address
  });
  if (NOMINATIM_EMAIL) osmParams.set("email", NOMINATIM_EMAIL);

  const url = `https://nominatim.openstreetmap.org/search?${osmParams.toString()}`;
  debug("OSM GET " + url);
  const r = await fetch(url, { headers: { 'Accept-Language': 'en' } });
  if (!r.ok) throw new Error("OSM HTTP " + r.status);
  const j = await r.json();
  if (!Array.isArray(j) || !j.length) throw new Error("OSM: no results");
  const comp = j[0].address || {};

  // Derive USPS state code robustly
  const iso =
    comp["ISO3166-2-lvl4"] || comp["ISO3166-2-lvl3"] || comp["ISO3166-2-lvl2"] || "";
  const isoMatch = /US-([A-Z]{2})/.exec(String(iso));
  const fromIso = isoMatch ? isoMatch[1] : "";

  const uspsByName = {
    "ALABAMA":"AL","ALASKA":"AK","ARIZONA":"AZ","ARKANSAS":"AR","CALIFORNIA":"CA",
    "COLORADO":"CO","CONNECTICUT":"CT","DELAWARE":"DE","DISTRICT OF COLUMBIA":"DC",
    "FLORIDA":"FL","GEORGIA":"GA","HAWAII":"HI","IDAHO":"ID","ILLINOIS":"IL",
    "INDIANA":"IN","IOWA":"IA","KANSAS":"KS","KENTUCKY":"KY","LOUISIANA":"LA",
    "MAINE":"ME","MARYLAND":"MD","MASSACHUSETTS":"MA","MICHIGAN":"MI","MINNESOTA":"MN",
    "MISSISSIPPI":"MS","MISSOURI":"MO","MONTANA":"MT","NEBRASKA":"NE","NEVADA":"NV",
    "NEW HAMPSHIRE":"NH","NEW JERSEY":"NJ","NEW MEXICO":"NM","NEW YORK":"NY",
    "NORTH CAROLINA":"NC","NORTH DAKOTA":"ND","OHIO":"OH","OKLAHOMA":"OK",
    "OREGON":"OR","PENNSYLVANIA":"PA","RHODE ISLAND":"RI","SOUTH CAROLINA":"SC",
    "SOUTH DAKOTA":"SD","TENNESSEE":"TN","TEXAS":"TX","UTAH":"UT","VERMONT":"VT",
    "VIRGINIA":"VA","WASHINGTON":"WA","WEST VIRGINIA":"WV","WISCONSIN":"WI","WYOMING":"WY",
    "PUERTO RICO":"PR","GUAM":"GU","NORTHERN MARIANA ISLANDS":"MP","AMERICAN SAMOA":"AS",
    "UNITED STATES VIRGIN ISLANDS":"VI"
  };

  const stateName = String(comp.state || "").toUpperCase().trim();
  let state = "";

  if (fromIso) {
    state = fromIso;
  } else if (stateName in uspsByName) {
    state = uspsByName[stateName];
  } else if (/^[A-Z]{2}$/.test(String(comp.state_code || ""))) {
    state = String(comp.state_code).toUpperCase();
  }

  // Use at-large if applicable, otherwise ask Census for district using lat/lon
  if (state) {
    if (AL_STATES.has(state)) {
      return { state, district: "AL" };
    }
    const lat = parseFloat(j[0].lat), lon = parseFloat(j[0].lon);
    if (!Number.isNaN(lat) && !Number.isNaN(lon)) {
      const district = await fetchCensusDistrict(lat, lon, debug);
      if (district) return { state, district };
      debug("Census geocoder did not return a district for these coordinates");
    } else {
      debug("OSM did not provide usable lat/lon");
    }
  }
  debug("OSM fallback needs manual selection");
} catch (e) {
  debug("OSM fallback failed: " + e.message);
}
// 3) Require manual selection
      throw new Error('Automatic resolver unavailable on this network. Use the manual state/district selector below.');
    }

    async function onGoClick(){
      hideMsg(); dbgpre.textContent = "";
      try {
        if (!CURRENT.length) await loadMembers();
        const address = addrEl.value.trim();
        if (!address) { showMsg("Enter an address.", "warn"); return; }
        const where = await resolveAddress(address);
        const people = findMembers(where);
        if (!people.length) showMsg('No current members found for '+where.state+'-'+where.district+'.', 'warn');
        renderResults(people);
      } catch (e){
        showMsg(e.message, "err");
      }
    }

    goBtn.addEventListener('click', function(ev){ ev.preventDefault(); onGoClick(); });
    (sampleBtn) && sampleBtn.addEventListener('click', function(ev){ ev.preventDefault(); addrEl.value = "1600 Pennsylvania Ave NW, Washington, DC"; onGoClick(); });

    // Name search wiring
    const nameInput = document.getElementById('nameQuery');
    const nameBtn = document.getElementById('searchByName');
    if (nameBtn) nameBtn.addEventListener('click', function(){ hideMsg(); const q = nameInput && nameInput.value || ''; const people = searchMembersByName(q); renderResults(people); });
    if (nameInput) nameInput.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); nameBtn && nameBtn.click(); }});

    goManual.addEventListener('click', function(){
      hideMsg();
      const state = stateSel.value;
      const district = distSel.value || "AL";
      const people = findMembers({state, district});
      renderResults(people);
    });

    // Eager load
    loadMembers().catch(e=>showMsg(e.message,'err'));
  });
  </script>
</body>
</html>
