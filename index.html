<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Demosthenes — Find Your Representatives</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#111827; --muted:#6b7280; --card:#fafafa; --border:#e5e7eb; --accent:#2563eb; --warn:#b45309; --err:#b91c1c; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); margin:24px; }
    h1 { font-size:1.8rem; margin:0 0 8px; }
    p.hint { color:var(--muted); margin-top:0; }
    .wrap { display:grid; grid-template-columns: 1fr; gap:16px; max-width:1000px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    input[type="text"] { padding:.6rem .8rem; font-size:1rem; border:1px solid var(--border); border-radius:8px; min-width:280px; flex:1; }
    button { padding:.6rem .9rem; font-size:1rem; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:white; border-color:var(--accent); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; }
    .settings { font-size:.95rem; color:var(--muted); }
    .result-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
    .member { display:flex; gap:12px; align-items:flex-start; }
    img.portrait { width:72px; height:96px; object-fit:cover; border-radius:8px; border:1px solid var(--border); background:#fff; }
    a.btn { display:inline-block; margin-top:6px; text-decoration:none; color:var(--accent); }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .dim { color:var(--muted); }
    .msg { padding:8px 10px; border-radius:8px; margin-top:8px; border:1px solid var(--border); background:#fff; white-space:pre-wrap; }
    .msg.warn { border-color:#fed7aa; background:#fffbeb; color:var(--warn); }
    .msg.err  { border-color:#fecaca; background:#fef2f2; color:#991b1b; }
    details { margin-top:8px; }
    summary { cursor:pointer; }
    #debug pre { background:#fff; border:1px solid var(--border); padding:8px; border-radius:8px; overflow:auto; max-height:300px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    label.select { display:block; font-size:.95rem; color:var(--muted); }
    select { padding:.45rem .6rem; border:1px solid var(--border); border-radius:8px; font-size:1rem; width:100%; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Demosthenes</h1>
      <p class="hint">Type your address to find your two Senators and your Representative.
        If network blocks third‑party APIs, use the manual state/district selector.</p>
    </header>

    <section class="card">
      <div class="row">
        <input id="addr" type="text" placeholder="e.g., 1600 Pennsylvania Ave NW, Washington, DC" />
        <button class="primary" id="go">Find my reps</button>
        <button id="useSample">Try sample</button>
      </div>
      <div class="settings" style="margin-top:8px;">
        Data base: <span class="mono" id="dataBaseLabel"></span>
        · Optional API base: <span class="mono" id="apiBaseLabel"></span>
        <div class="row" style="margin-top:6px">
          <label>Set API base (optional): <input id="apiBase" type="text" placeholder="https://your-api.example.com" style="min-width:360px;" /></label>
          <button id="saveApi">Save</button>
          <button id="clearApi">Clear</button>
        </div>
        <div id="msg" class="msg warn" style="display:none;"></div>
        <details id="debug"><summary>Debug info</summary><pre id="dbgpre"></pre></details>
      </div>
    </section>

    <section class="card">
      <h3>Manual selector (no external calls)</h3>
      <div class="grid2">
        <label class="select">State
          <select id="stateSel"></select>
        </label>
        <label class="select">District
          <select id="distSel"></select>
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="goManual">Show my reps</button>
      </div>
    </section>

    <section id="results" class="result-grid"></section>

    <footer class="dim">
      Data: Voteview + congress-legislators · Address resolver: optional server proxy → OSM fallback → manual selector.
    </footer>
  </div>

  <script>
  window.addEventListener('error', function(e){
    const msg = document.getElementById('msg');
    if (!msg) return;
    msg.textContent = 'JS error: ' + (e.message || e.error);
    msg.className = 'msg err';
    msg.style.display = 'block';
  });

  window.addEventListener('DOMContentLoaded', function(){
    const DATA_BASE = "https://WyattBrannon.github.io/demosthenes-data";
    const BASE = (localStorage.getItem("DEMOS_DATA_BASE") || DATA_BASE).replace(/\/+$/,"");
    const dataBaseLabel = document.getElementById("dataBaseLabel");
    dataBaseLabel.textContent = BASE;

    const YAML_URL = `${BASE}/legislators-current.yaml`;

    const addrEl = document.getElementById("addr");
    const goBtn = document.getElementById("go");
    const sampleBtn = document.getElementById("useSample");
    const res = document.getElementById("results");
    const msg = document.getElementById("msg");
    const dbgpre = document.getElementById("dbgpre");

    const apiBaseInput = document.getElementById('apiBase');
    const saveApiBtn = document.getElementById('saveApi');
    const clearApiBtn = document.getElementById('clearApi');
    const apiBaseLabel = document.getElementById('apiBaseLabel');

    function getApiBase(){ return localStorage.getItem('DEMOS_API_BASE') || ''; }
    function setApiUI(){ apiBaseInput.value = getApiBase(); apiBaseLabel.textContent = getApiBase() || '(none)'; }
    saveApiBtn.onclick = ()=>{ localStorage.setItem('DEMOS_API_BASE', apiBaseInput.value.trim()); setApiUI(); };
    clearApiBtn.onclick = ()=>{ localStorage.removeItem('DEMOS_API_BASE'); setApiUI(); };
    setApiUI();

    function debug(line){ dbgpre.textContent += line + "\n"; }
    function showMsg(text, kind="warn"){ msg.textContent = text; msg.className = "msg " + kind; msg.style.display = 'block'; }
    function hideMsg(){ msg.style.display = 'none'; }

    function el(tag, attrs = {}, children = []){ const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>k==="class"?(n.className=v):v!=null&&n.setAttribute(k,v)); (Array.isArray(children)?children:[children]).forEach(c=>n.appendChild(typeof c==="string"?document.createTextNode(c):c)); return n; }
    function normalizeName(s){ return (s||"").toLowerCase().replace(/[^a-z\s]/g,"").replace(/\s+/g," ").trim(); }

    const todayISO = new Date().toISOString().slice(0,10);
    let CURRENT = [];
    const STATES = ["AL","AK","AZ","AR","CA","CO","CT","DE","DC","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
    const AL_STATES = new Set(["AK","DE","DC","MT","ND","SD","VT","WY"]);

    // Manual selector state
    const stateSel = document.getElementById('stateSel');
    const distSel = document.getElementById('distSel');
    const goManual = document.getElementById('goManual');

    function populateStates(){
      stateSel.innerHTML = STATES.map(s=>`<option value="${s}">${s}</option>`).join("");
    }
    function populateDistrictsFor(state){
      const maxByState = {
        "AL":7,"AK":1,"AZ":9,"AR":4,"CA":52,"CO":8,"CT":5,"DE":1,"DC":1,"FL":28,"GA":14,"HI":2,"ID":2,"IL":17,"IN":9,"IA":4,"KS":4,"KY":6,"LA":6,"ME":2,"MD":8,"MA":9,"MI":13,"MN":8,"MS":4,"MO":8,"MT":2,"NE":3,"NV":4,"NH":2,"NJ":12,"NM":3,"NY":26,"NC":14,"ND":1,"OH":15,"OK":5,"OR":6,"PA":17,"RI":2,"SC":7,"SD":1,"TN":9,"TX":38,"UT":4,"VT":1,"VA":11,"WA":10,"WV":2,"WI":8,"WY":1
      };
      const n = maxByState[state] || 1;
      const isAL = (n===1);
      distSel.innerHTML = isAL ? `<option value="AL">At-Large</option>`
                               : Array.from({length:n},(_,i)=>`<option value="${String(i+1).padStart(2,"0")}">${i+1}</option>`).join("");
    }

    populateStates();
    stateSel.value = "DC"; populateDistrictsFor("DC");
    stateSel.addEventListener('change', ()=> populateDistrictsFor(stateSel.value));

    async function loadMembers(){
      const r = await fetch(YAML_URL, {cache:"no-store"});
      if (!r.ok) throw new Error('Failed to load legislators-current.yaml ('+r.status+')');
      const text = await r.text();
      const yamlObj = jsyaml.load(text);
      CURRENT = yamlObj.map(rec=>{
        const terms=rec?.terms||[]; if(!terms.length) return null;
        const t=terms[terms.length-1]; const type=(t.type||"").toLowerCase(); const end=t.end||"";
        if (!((type==="rep"||type==="sen") && (!end || end >= todayISO))) return null;
        return {
          bioguide: rec?.id?.bioguide,
          name: [rec?.name?.first, rec?.name?.middle, rec?.name?.last].filter(Boolean).join(" "),
          state: t.state,
          district: type==="rep" ? (t.district ?? "") : "",
          chamber: type==="rep" ? "house" : "senate",
          party: t.party || (rec?.party)||"",
          norm: normalizeName([rec?.name?.first, rec?.name?.middle, rec?.name?.last].filter(Boolean).join(" "))
        };
      }).filter(Boolean);
      showMsg("Loaded members: " + CURRENT.length, "warn");
    }

    function findMembers(where){
      const {state, district} = where;
      const senators = CURRENT.filter(m => m.chamber==="senate" && m.state===state);
      const rep = CURRENT.find(m => m.chamber==="house" && m.state===state && ((m.district===0||m.district===""||m.district==null) ? district==="AL" : String(m.district).padStart(2,"0")===district));
      const reps = [...senators];
      if (rep) reps.push(rep);
      return reps;
    }

    function renderResults(people){
      const BASE = (localStorage.getItem("DEMOS_DATA_BASE") || "https://WyattBrannon.github.io/demosthenes-data").replace(/\/+$/,"");
      res.innerHTML = "";
      if (!people.length) {
        res.appendChild(el("div",{class:"card"}, "No matches found."));
        return;
      }
      const IMG_URL_MEMBER = (bioguide) => `${BASE}/images/${bioguide}.jpg`;
      for (const p of people){
        const a = el("a",{href:`member.html?bioguide=${encodeURIComponent(p.bioguide)}`,"class":"btn"},"View report →");
        const img = el("img",{class:"portrait",src:IMG_URL_MEMBER(p.bioguide),alt:p.name});
        img.onerror = () => { img.style.visibility="hidden"; img.style.height="0"; };
        const seat = p.chamber==="senate" ? `(${p.state})` : `(${p.state}-${(p.district===0||p.district===""||p.district==null)?"AL":String(p.district).padStart(2,"0")})`;
        const card = el("div",{class:"card"},[
          el("div",{class:"member"},[
            img,
            el("div",{},[
              el("div",{},`${p.name}`),
              el("div",{class:"dim"}, `${p.chamber==="senate"?"Senator":"Representative"} ${seat}`),
              a
            ])
          ])
        ]);
        res.appendChild(card);
      }
    }

    async function callServerResolve(address){
      const apiBase = getApiBase();
      if (!apiBase) throw new Error('No DEMOS_API_BASE configured');
      const url = apiBase.replace(/\/+$/,"") + '/resolve?address=' + encodeURIComponent(address);
      debug('API GET ' + url);
      const r = await fetch(url);
      if (!r.ok) throw new Error('API HTTP ' + r.status);
      const j = await r.json();
      if (!j || !j.state || !j.district) throw new Error('API invalid payload');
      return { state: j.state, district: j.district };
    }

    async function resolveAddress(address){
      // 1) Try user-provided server API (if configured)
      try {
        if (getApiBase()) {
          const res = await callServerResolve(address);
          debug('Resolved via API: ' + JSON.stringify(res));
          return res;
        }
      } catch (e) {
        debug('API failed: ' + e.message);
      }
      // 2) Fallback: quick OSM geocode and simple guess (best-effort; can be wrong in multi-district states)
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=${encodeURIComponent(address)}`;
        debug("OSM GET " + url);
        const r = await fetch(url, { headers: { 'Accept-Language': 'en' } });
        if (!r.ok) throw new Error("OSM HTTP "+r.status);
        const j = await r.json();
        if (!Array.isArray(j) || !j.length) throw new Error("OSM: no results");
        const comp = j[0].address || {};
        const state = (comp.state_code || comp.state || "").toString().toUpperCase().slice(0,2);
        // As we can't reliably get CD client-side on your network, we default to AL for AL states else show manual selector
        const district = AL_STATES.has(state) ? "AL" : "";
        if (state && district) return { state, district };
        debug('OSM fallback needs manual selection');
      } catch (e) {
        debug('OSM fallback failed: ' + e.message);
      }
      // 3) Require manual selection
      throw new Error('Automatic resolver unavailable on this network. Use the manual state/district selector below.');
    }

    async function onGoClick(){
      hideMsg(); dbgpre.textContent = "";
      try {
        if (!CURRENT.length) await loadMembers();
        const address = addrEl.value.trim();
        if (!address) { showMsg("Enter an address.", "warn"); return; }
        const where = await resolveAddress(address);
        const people = findMembers(where);
        if (!people.length) showMsg('No current members found for '+where.state+'-'+where.district+'.', 'warn');
        renderResults(people);
      } catch (e){
        showMsg(e.message, "err");
      }
    }

    goBtn.addEventListener('click', function(ev){ ev.preventDefault(); onGoClick(); });
    sampleBtn.addEventListener('click', function(ev){ ev.preventDefault(); addrEl.value = "1600 Pennsylvania Ave NW, Washington, DC"; onGoClick(); });

    goManual.addEventListener('click', function(){
      hideMsg();
      const state = stateSel.value;
      const district = distSel.value || "AL";
      const people = findMembers({state, district});
      renderResults(people);
    });

    // Eager load
    loadMembers().catch(e=>showMsg(e.message,'err'));
  });
  </script>
</body>
</html>
