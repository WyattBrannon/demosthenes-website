<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Demosthenes — Members & DW‑NOMINATE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#111827; --muted:#6b7280; --card:#fafafa; --border:#e5e7eb; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); margin:24px; }
    h1 { font-size:1.6rem; margin-bottom:8px; }
    p.hint { color:var(--muted); margin-top:0; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:16px 0; }
    input[type="search"], select { padding:.55rem .75rem; font-size:1rem; border:1px solid var(--border); border-radius:8px; min-width:260px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-top:12px; }
    .row { display:flex; gap:16px; align-items:flex-start; }
    img.portrait { width:130px; height:auto; border-radius:10px; border:1px solid var(--border); background:#fff; object-fit:cover; }
    .kv { margin:4px 0; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .pill { display:inline-block; min-width:80px; text-align:center; padding:2px 8px; border-radius:999px; }
    .pill.red { background:#fee2e2; }
    .pill.blue { background:#dbeafe; }
    .pill.gray { background:#e5e7eb; }
    .dim { color:var(--muted); }
    .legend { margin-top:12px; color:var(--muted); font-size:.95rem; line-height:1.35; }
    /* ideology bar */
    .ideo-wrap { margin-top:8px; }
    .ideo-scale {
      position: relative;
      height: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(90deg, #3b82f6 0%, #ef4444 100%); /* blue → red */
      overflow: visible;
    }
    .ideo-marker {
      position: absolute; top: 50%;
      width: 10px; height: 10px; background: #111; border-radius: 2px;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 0 2px rgba(255,255,255,.9);
    }
    .ideo-labels { display:flex; justify-content:space-between; font-size:.85rem; color:var(--muted); margin-top:4px; }
    .footer { margin-top:28px; font-size:.9rem; color:var(--muted); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <h1>Demosthenes</h1>
  <p class="hint">Current <b>House & Senate</b> members with DW‑NOMINATE scores (Dim1 & Dim2).</p>

  <div class="controls">
    <input id="search" type="search" placeholder="Search by name, bioguide, party, state…" />
    <select id="picker">
      <option value="">— choose a member —</option>
    </select>
    <span id="count" class="dim"></span>
  </div>

  <div id="card" class="card">Select a member…</div>

  <div class="legend">
    <b>What do these mean?</b><br/>
    <b>Dim1</b> ≈ liberal ↔ conservative ideology (≈ −1 left, +1 right). The black square marks the member’s Dim1 on the blue→red bar.<br/>
    <b>Dim2</b> captures secondary cleavages (e.g., regional/issue splits). It’s often near 0 in modern Congresses.
  </div>

  <div class="footer">
    Data: Voteview + congress‑legislators · Photos: unitedstates/images · Served from <span class="mono">demosthenes-data</span>.
  </div>

  <script>
    // ------- Config -------
    const DATA_BASE = "https://WyattBrannon.github.io/demosthenes-data"; // change username if needed
    const todayISO = new Date().toISOString().slice(0,10);
    const override = localStorage.getItem("DEMOS_DATA_BASE");
    const BASE = override && /^https?:\/\//.test(override) ? override.replace(/\/+$/,"") : DATA_BASE;

    const INDEX_URL = `${BASE}/indexes/members_index.tsv`;
    const YAML_URL  = `${BASE}/legislators-current.yaml`;
    const IMG_URL   = (bioguide) => `${BASE}/images/${bioguide}.jpg`;

    // ------- utils -------
    function el(tag, attrs = {}, children = []) {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => k==="class" ? (n.className=v) : v!=null && n.setAttribute(k,v));
      (Array.isArray(children)?children:[children]).forEach(c => n.appendChild(typeof c==="string" ? document.createTextNode(c) : c));
      return n;
    }
    async function fetchText(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error("Fetch failed "+url); return r.text(); }
    async function fetchTSV(url){
      const text = await fetchText(url);
      const lines = text.trim().split(/\r?\n/);
      const headers = lines.shift().split("\t");
      return lines.map(line => {
        const cols = line.split("\t"); const o = {};
        headers.forEach((h,i)=>o[h]=cols[i]??"");
        return o;
      });
    }
    function formatNameFromYaml(rec){ const nm=rec?.name||{}; return [nm.first,nm.middle,nm.last].filter(Boolean).join(" "); }
    function lastNameFromYaml(rec){ return (rec?.name?.last || "").toString(); }
    function partyCodeToLetter(code){
      const c = (code||"").toString().trim();
      if (c === "100") return "D";
      if (c === "200") return "R";
      if (["328","329","331"].includes(c)) return "I";
      return "";
    }
    function partyBadge(partyName, partyCode){
      const label = (partyName || "").trim() || partyCodeToLetter(partyCode) || "?";
      const up = label.toUpperCase();
      const cls = up.startsWith("D") ? "blue" : up.startsWith("R") ? "red" : "gray";
      return `<span class="pill ${cls}">${up}</span>`;
    }
    function seatText(chamber, stateAbbrev, district){
      const c = (chamber||"").toLowerCase();
      if (c==="house" || c==="rep") {
        const d = (district===0 || district==="0") ? "AL" : (district||"").toString().padStart(2,"0");
        return `(${stateAbbrev || "??"}-${d})`;
      } else {
        return `(${stateAbbrev || "??"})`;
      }
    }
    // map Dim1 in [-1,1] → 0..100% (clamp just in case)
    function dim1ToPercent(dim1){
      if (dim1 == null || !isFinite(dim1)) return null;
      const p = ((dim1 + 1) / 2) * 100;
      return Math.max(0, Math.min(100, p));
    }

    // ------- render -------
    function renderMemberCard(target, info){
      if(!info){ target.textContent="Select a member…"; return; }

      const dim1 = info.dw_nominate!=="" ? Number(info.dw_nominate) : null;
      const dim1Str = (dim1!=null && isFinite(dim1)) ? dim1.toFixed(3) : "N/A";

      const rawDim2 = info.dw_nominate2 ?? info.nominate_dim2 ?? "";
      const dim2 = rawDim2!=="" ? Number(rawDim2) : null;
      const dim2Str = (dim2!=null && isFinite(dim2)) ? dim2.toFixed(3) : "N/A";

      target.innerHTML="";
      const img = el("img",{class:"portrait",src:IMG_URL(info.bioguide_id),alt:info.name||info.bioguide_id});
      img.onerror = () => { img.style.visibility="hidden"; img.style.height="0"; };

      // ideology bar with marker
      const p = dim1ToPercent(dim1);
      const bar = el("div",{class:"ideo-wrap"},[
        el("div",{class:"ideo-scale"}, p==null ? [] : el("div",{class:"ideo-marker", style:`left:${p}%;`}))
      ]);
      const axis = el("div",{class:"ideo-labels"},[
        el("span",{}, "−1 (liberal)"),
        el("span",{}, "0"),
        el("span",{}, "+1 (conservative)")
      ]);

      const meta = el("div",{},[
        el("h3",{},`${info.name||info.bioguide_id} ${partyBadge(info.party_name, info.party_code)} ${seatText(info.chamber, info.state_abbrev, info.district)}`),
        el("div",{class:"kv"} ,`Bioguide: ${info.bioguide_id}`),
        el("div",{class:"kv"} ,`Chamber: ${info.chamber || "?"}`),
        el("div",{class:"kv"} ,`DW‑NOMINATE Dim1: ${dim1Str}`),
        bar,
        axis,
        el("div",{class:"kv"} ,`DW‑NOMINATE Dim2: ${dim2Str}`)
      ]);

      target.appendChild(el("div",{class:"row"},[img,meta]));
    }

    // ------- main -------
    (async function(){
      const out = document.getElementById("card");
      const search = document.getElementById("search");
      const picker = document.getElementById("picker");
      const countEl = document.getElementById("count");

      out.textContent="Loading data…";

      // 1) Current members from YAML (both chambers)
      const yamlText = await fetchText(YAML_URL);
      const yamlObj = jsyaml.load(yamlText);

      const currentSet = new Set();
      const nameByBioguide = {};
      const lastByBioguide = {};
      const seatByBioguide = {};

      for(const rec of yamlObj){
        const terms = rec?.terms||[];
        if(!terms.length) continue;
        const lastTerm = terms[terms.length-1];
        const type = (lastTerm.type||"").toLowerCase(); // "rep" or "sen"
        const end  = lastTerm.end || "";
        const bid  = rec?.id?.bioguide;
        if(!bid) continue;
        if ((type==="rep" || type==="sen") && (!end || end >= todayISO)){
          currentSet.add(bid);
          nameByBioguide[bid] = formatNameFromYaml(rec);
          lastByBioguide[bid] = lastNameFromYaml(rec);
          seatByBioguide[bid] = {
            chamber: type==="rep" ? "House" : "Senate",
            state_abbrev: lastTerm.state,
            district: type==="rep" ? (lastTerm.district ?? "") : ""
          };
        }
      }

      // 2) DW‑NOM index TSV → filter to current members; prefer rows with Dim1 present
      const tsv = await fetchTSV(INDEX_URL);
      const byBioguide = new Map();
      for(const r of tsv){
        const bid = r.bioguide_id;
        if(!currentSet.has(bid)) continue;
        const have = byBioguide.get(bid);
        const thisHasDim1 = r.dw_nominate !== "";
        if(!have) byBioguide.set(bid, r);
        else if(!have.dw_nominate && thisHasDim1) byBioguide.set(bid, r);
      }

      const rows = Array.from(byBioguide.values()).map(r => {
        const seat = seatByBioguide[r.bioguide_id] || {};
        return {
          ...r,
          name: nameByBioguide[r.bioguide_id] || r.bioguide_id,
          last_name: lastByBioguide[r.bioguide_id] || (nameByBioguide[r.bioguide_id]||"").split(" ").slice(-1)[0] || "",
          chamber: seat.chamber || r.chamber || "",
          state_abbrev: seat.state_abbrev || r.state_abbrev || "",
          district: seat.district ?? r.district ?? ""
        };
      });

      // 3) UI: search + dropdown (sorted by LAST name)
      function matches(d,q){
        if(!q) return true;
        const s=q.toLowerCase();
        return (
          (d.name||"").toLowerCase().includes(s) ||
          (d.last_name||"").toLowerCase().includes(s) ||
          (d.bioguide_id||"").toLowerCase().includes(s) ||
          (d.party_name||d.party_code||"").toLowerCase().includes(s) ||
          (d.state_abbrev||"").toLowerCase().includes(s)
        );
      }
      function populate(q=""){
        const list = rows
          .filter(d=>matches(d,q))
          .sort((a,b)=>{
            const la=a.last_name.toLowerCase(), lb=b.last_name.toLowerCase();
            if(la<lb) return -1; if(la>lb) return 1;
            return a.name.localeCompare(b.name);
          });

        picker.innerHTML = '<option value="">— choose a member —</option>';
        for(const d of list){
          const dim1 = d.dw_nominate ? Number(d.dw_nominate).toFixed(3) : "N/A";
          const dim2Raw = d.dw_nominate2 ?? d.nominate_dim2 ?? "";
          const dim2 = dim2Raw!=="" ? Number(dim2Raw).toFixed(3) : "N/A";
          const party = (d.party_name || partyCodeToLetter(d.party_code) || "?");
          const seat = seatText(d.chamber, d.state_abbrev, d.district);
          const firstNames = d.name.replace(new RegExp(d.last_name+'$'),'').trim();
          const label = `${d.last_name.toUpperCase()}, ${firstNames} · ${party} ${seat} · Dim1: ${dim1} | Dim2: ${dim2}`;
          picker.appendChild(el("option",{value:d.bioguide_id},label));
        }
        countEl.textContent = `${list.length} shown`;
      }

      document.getElementById("search").addEventListener("input",()=>populate(document.getElementById("search").value));
      picker.addEventListener("change",()=>{
        const rec = rows.find(r=>r.bioguide_id===picker.value);
        renderMemberCard(out, rec);
      });

      populate("");
      out.textContent="Select a member…";
    })().catch(err=>{
      document.getElementById("card").textContent = `Failed to load: ${err}`;
    });
  </script>
</body>
</html>
