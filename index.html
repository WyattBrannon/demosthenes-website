<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Demosthenes — Find Your Representatives</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#111827; --muted:#6b7280; --card:#fafafa; --border:#e5e7eb; --accent:#2563eb; --warn:#b45309; --err:#b91c1c; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); margin:24px; }
    h1 { font-size:1.8rem; margin:0 0 8px; }
    p.hint { color:var(--muted); margin-top:0; }
    .wrap { display:grid; grid-template-columns: 1fr; gap:16px; max-width:900px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    input[type="text"] { padding:.6rem .8rem; font-size:1rem; border:1px solid var(--border); border-radius:8px; min-width:280px; flex:1; }
    button { padding:.6rem .9rem; font-size:1rem; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:white; border-color:var(--accent); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; }
    .settings { font-size:.95rem; color:var(--muted); }
    .result-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
    .member { display:flex; gap:12px; align-items:flex-start; }
    img.portrait { width:72px; height:96px; object-fit:cover; border-radius:8px; border:1px solid var(--border); background:#fff; }
    a.btn { display:inline-block; margin-top:6px; text-decoration:none; color:var(--accent); }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .dim { color:var(--muted); }
    .msg { padding:8px 10px; border-radius:8px; margin-top:8px; border:1px solid var(--border); background:#fff; white-space:pre-wrap; }
    .msg.warn { border-color:#fed7aa; background:#fffbeb; color:var(--warn); }
    .msg.err  { border-color:#fecaca; background:#fef2f2; color:var(--err); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Demosthenes</h1>
      <p class="hint">Type your address to find your two Senators and your Representative (via the free U.S. Census Geocoder).</p>
    </header>

    <section class="card">
      <div class="row">
        <input id="addr" type="text" placeholder="e.g., 1600 Pennsylvania Ave NW, Washington, DC" />
        <button class="primary" id="go">Find my reps</button>
        <button id="useSample">Try sample</button>
      </div>
      <div class="settings" style="margin-top:8px;">
        Data source: <span class="mono" id="dataBaseLabel"></span>
        <div id="msg" class="msg warn" style="display:none;"></div>
      </div>
    </section>

    <section id="results" class="result-grid"></section>

    <footer class="dim">
      Data: Voteview + congress-legislators · Address lookup: U.S. Census Geocoder.
    </footer>
  </div>

  <script>
  window.addEventListener('error', function(e){
    var msg = document.getElementById('msg');
    if (!msg) return;
    msg.textContent = 'JS error: ' + (e.message || e.error);
    msg.className = 'msg err';
    msg.style.display = 'block';
  });

  window.addEventListener('DOMContentLoaded', function(){
    const DATA_BASE = "https://WyattBrannon.github.io/demosthenes-data";
    const BASE = (localStorage.getItem("DEMOS_DATA_BASE") || DATA_BASE).replace(/\/+$/,"");
    const YAML_URL  = `${BASE}/legislators-current.yaml`;
    const IMG_URL   = (bioguide) => `${BASE}/images/${bioguide}.jpg`;

    const addrEl = document.getElementById("addr");
    const goBtn = document.getElementById("go");
    const sampleBtn = document.getElementById("useSample");
    const res = document.getElementById("results");
    const dataBaseLabel = document.getElementById("dataBaseLabel");
    const msg = document.getElementById("msg");
    dataBaseLabel.textContent = BASE;

    function showMsg(text, kind="warn"){ msg.textContent = text; msg.className = "msg " + kind; msg.style.display = "block"; }
    function hideMsg(){ msg.style.display = "none"; }

    function el(tag, attrs = {}, children = []){ const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>k==="class"?(n.className=v):v!=null&&n.setAttribute(k,v)); (Array.isArray(children)?children:[children]).forEach(c=>n.appendChild(typeof c==="string"?document.createTextNode(c):c)); return n; }
    function normalizeName(s){ return (s||"").toLowerCase().replace(/[^a-z\s]/g,"").replace(/\s+/g," ").trim(); }

    const todayISO = new Date().toISOString().slice(0,10);
    let CURRENT = [];

    async function loadMembers(){
      try{
        const yamlResp = await fetch(YAML_URL,{cache:"no-store"});
        if (!yamlResp.ok) throw new Error('Failed to load legislators-current.yaml ('+yamlResp.status+')');
        const yamlText = await yamlResp.text();
        const yamlObj = jsyaml.load(yamlText);
        CURRENT = yamlObj.map(rec=>{
          const terms=rec?.terms||[]; if(!terms.length) return null;
          const t=terms[terms.length-1]; const type=(t.type||"").toLowerCase(); const end=t.end||"";
          if (!((type==="rep"||type==="sen") && (!end || end >= todayISO))) return null;
          return {
            bioguide: rec?.id?.bioguide,
            name: [rec?.name?.first, rec?.name?.middle, rec?.name?.last].filter(Boolean).join(" "),
            state: t.state,
            district: type==="rep" ? (t.district ?? "") : "",
            chamber: type==="rep" ? "house" : "senate",
            party: t.party || (rec?.party)||"",
            norm: normalizeName([rec?.name?.first, rec?.name?.middle, rec?.name?.last].filter(Boolean).join(" "))
          };
        }).filter(Boolean);
      }catch(e){
        showMsg('Loading members failed: ' + e.message, 'err');
      }
    }

    // FIPS map includes DC
    const FIPS_TO_ABBR = {"01":"AL","02":"AK","04":"AZ","05":"AR","06":"CA","08":"CO","09":"CT","10":"DE","11":"DC","12":"FL","13":"GA","15":"HI","16":"ID","17":"IL","18":"IN","19":"IA","20":"KS","21":"KY","22":"LA","23":"ME","24":"MD","25":"MA","26":"MI","27":"MN","28":"MS","29":"MO","30":"MT","31":"NE","32":"NV","33":"NH","34":"NJ","35":"NM","36":"NY","37":"NC","38":"ND","39":"OH","40":"OK","41":"OR","42":"PA","44":"RI","45":"SC","46":"SD","47":"TN","48":"TX","49":"UT","50":"VT","51":"VA","53":"WA","54":"WV","55":"WI","56":"WY"};

    async function censusGeocode(address){
      const params = new URLSearchParams({
        address,
        benchmark: "Public_AR_Census2020",
        vintage: "Current_Census2020",
        layers: "Congressional Districts",
        format: "json"
      });
      const url = `https://geocoding.geo.census.gov/geocoder/geographies/onelineaddress?${params.toString()}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error("Census Geocoder HTTP "+r.status);
      const j = await r.json();
      const match = j?.result?.addressMatches?.[0];
      if (!match) throw new Error("No address match found.");
      const geogs = match?.geographies || {};
      const cdList = geogs["Congressional Districts"] || geogs["118th Congressional Districts"] || geogs["116th Congressional Districts"] || [];
      const cd = cdList[0] || {};
      const stateFips = cd.STATE || match?.addressComponents?.state_fips || "";
      const state = FIPS_TO_ABBR[stateFips] || match?.addressComponents?.state || "";
      let district = cd.CD118 || cd.CD116 || cd.CENTDIST || cd.BASENAME || "";
      let districtStr = "";
      if (!district || /at[-\s]?large/i.test(String(district))) {
        districtStr = "AL";
      } else if (/^\d+$/.test(String(district))) {
        const n = parseInt(district, 10);
        districtStr = n===0 ? "AL" : String(n).padStart(2,"0");
      } else {
        districtStr = "AL";
      }
      return { state, district: districtStr };
    }

    function findMembers(where){
      const {state, district} = where;
      const senators = CURRENT.filter(m => m.chamber==="senate" && m.state===state);
      const rep = CURRENT.find(m => m.chamber==="house" && m.state===state && ((m.district===0||m.district===""||m.district==null) ? district==="AL" : String(m.district).padStart(2,"0")===district));
      const reps = [...senators];
      if (rep) reps.push(rep);
      return reps;
    }

    function renderResults(people){
      res.innerHTML = "";
      if (!people.length) {
        res.appendChild(el("div",{class:"card"}, "No matches found."));
        return;
      }
      const IMG_URL = (bioguide) => `${BASE}/images/${bioguide}.jpg`;
      for (const p of people){
        const a = el("a",{href:`member.html?bioguide=${encodeURIComponent(p.bioguide)}`,"class":"btn"},"View report →");
        const img = el("img",{class:"portrait",src:IMG_URL(p.bioguide),alt:p.name});
        img.onerror = () => { img.style.visibility="hidden"; img.style.height="0"; };
        const seat = p.chamber==="senate" ? `(${p.state})` : `(${p.state}-${(p.district===0||p.district===""||p.district===null)?"AL":String(p.district).padStart(2,"0")})`;
        const card = el("div",{class:"card"},[
          el("div",{class:"member"},[
            img,
            el("div",{},[
              el("div",{},`${p.name}`),
              el("div",{class:"dim"}, `${p.chamber==="senate"?"Senator":"Representative"} ${seat}`),
              a
            ])
          ])
        ]);
        res.appendChild(card);
      }
    }

    async function onGoClick(){
      hideMsg();
      try {
        res.innerHTML = "";
        const address = addrEl.value.trim();
        if (!address) { showMsg("Enter an address.", "warn"); return; }
        const where = await censusGeocode(address);
        const people = findMembers(where);
        if (!people.length) {
          showMsg('No current members found for '+where.state+'-'+where.district+'.', 'warn');
        }
        renderResults(people);
      } catch (e){
        showMsg(e.message, "err");
      }
    }

    // Bind events safely
    goBtn.addEventListener('click', function(ev){ ev.preventDefault(); onGoClick(); });
    sampleBtn.addEventListener('click', function(ev){ ev.preventDefault(); addrEl.value = "1600 Pennsylvania Ave NW, Washington, DC"; onGoClick(); });

    // Kick off loading members
    loadMembers();
  });
  </script>
</body>
</html>
