<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Demosthenes — Find Your Representatives</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg:#111827; --muted:#6b7280; --card:#fafafa; --border:#e5e7eb; --accent:#2563eb; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); margin:24px; }
    h1 { font-size:1.8rem; margin:0 0 8px; }
    p.hint { color:var(--muted); margin-top:0; }
    .wrap { display:grid; grid-template-columns: 1fr; gap:16px; max-width:900px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    input[type="search"], input[type="text"] { padding:.6rem .8rem; font-size:1rem; border:1px solid var(--border); border-radius:8px; min-width:280px; flex:1; }
    button { padding:.6rem .9rem; font-size:1rem; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:white; border-color:var(--accent); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; }
    .settings { font-size:.95rem; color:var(--muted); }
    .result-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
    .member { display:flex; gap:12px; align-items:flex-start; }
    img.portrait { width:72px; height:96px; object-fit:cover; border-radius:8px; border:1px solid var(--border); background:#fff; }
    .pill { display:inline-block; min-width:22px; text-align:center; padding:1px 6px; border-radius:999px; font-weight:600; margin-left:6px; }
    .pill.red { background:#fee2e2; color:#991b1b; } .pill.blue { background:#dbeafe; color:#1e3a8a; } .pill.gray { background:#e5e7eb; color:#374151; }
    a.btn { display:inline-block; margin-top:6px; text-decoration:none; color:var(--accent); }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
    .dim { color:var(--muted); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Demosthenes</h1>
      <p class="hint">Type your address to find your two Senators and your Representative. Then view detailed reports.</p>
    </header>

    <section class="card">
      <div class="row">
        <input id="addr" type="text" placeholder="e.g., 1600 Pennsylvania Ave NW, Washington, DC" />
        <button class="primary" id="go">Find my reps</button>
        <button id="useLoc">Use my location</button>
      </div>
      <div class="settings" style="margin-top:8px;">
        Data source: <span class="mono" id="dataBaseLabel"></span> ·
        Civic API key: <span id="keyState" class="mono">not set</span>
        <br/>
        <label>Set Civic API key: <input id="civicKey" type="text" placeholder="AIza... (stored locally)" style="min-width:300px;" /></label>
        <button id="saveKey">Save</button>
        <button id="clearKey">Clear</button>
      </div>
    </section>

    <section id="results" class="result-grid"></section>

    <footer class="dim">
      Data: Voteview + congress-legislators · Address lookup: Google Civic Information API.
    </footer>
  </div>

  <script>
    // ---------- Config ----------
    const DATA_BASE = "https://WyattBrannon.github.io/demosthenes-data";
    const BASE = (localStorage.getItem("DEMOS_DATA_BASE") || DATA_BASE).replace(/\/+$/,"");
    const YAML_URL  = `${BASE}/legislators-current.yaml`;
    const IMG_URL   = (bioguide) => `${BASE}/images/${bioguide}.jpg`;

    // ---------- DOM ----------
    const addrEl = document.getElementById("addr");
    const goBtn = document.getElementById("go");
    const useLocBtn = document.getElementById("useLoc");
    const res = document.getElementById("results");
    const civicKeyEl = document.getElementById("civicKey");
    const saveKeyBtn = document.getElementById("saveKey");
    const clearKeyBtn = document.getElementById("clearKey");
    const keyState = document.getElementById("keyState");
    const dataBaseLabel = document.getElementById("dataBaseLabel");
    dataBaseLabel.textContent = BASE;

    // ---------- Helpers ----------
    function partyPill(party){
      const up = (party||"").toUpperCase();
      const cls = up.startsWith("D") ? "blue" : up.startsWith("R") ? "red" : "gray";
      return `<span class="pill ${cls}">${up.startsWith("D")?"D":up.startsWith("R")?"R":"I"}</span>`;
    }
    function textNode(s){ return document.createTextNode(s); }
    function el(tag, attrs = {}, children = []){
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => k==="class" ? (n.className=v) : v!=null && n.setAttribute(k,v));
      (Array.isArray(children)?children:[children]).forEach(c => n.appendChild(typeof c==="string" ? document.createTextNode(c) : c));
      return n;
    }
    function lastTermCurrent(rec, todayISO){
      const terms = rec?.terms || [];
      if (!terms.length) return null;
      const t = terms[terms.length-1];
      if ((t.type==="rep" || t.type==="sen") && (!t.end || t.end >= todayISO)) return t;
      return null;
    }
    function normalizeName(s){ return (s||"").toLowerCase().replace(/[^a-z\s]/g,"").replace(/\s+/g," ").trim(); }

    // ---------- Load current members ----------
    const todayISO = new Date().toISOString().slice(0,10);
    let CURRENT = []; // {bioguide, name, state, district, chamber, norm}
    (async function loadMembers(){
      const yamlText = await (await fetch(YAML_URL,{cache:"no-store"})).text();
      const yamlObj = jsyaml.load(yamlText);
      const out = [];
      for(const rec of yamlObj){
        const t = lastTermCurrent(rec, todayISO);
        if(!t) continue;
        out.push({
          bioguide: rec?.id?.bioguide,
          name: [rec?.name?.first, rec?.name?.middle, rec?.name?.last].filter(Boolean).join(" "),
          last: rec?.name?.last || "",
          state: t.state,
          district: t.type==="rep" ? (t.district ?? "") : "",
          chamber: t.type==="rep" ? "house" : "senate",
          party: (t.party || rec?.party || ""),
          norm: normalizeName([rec?.name?.first, rec?.name?.middle, rec?.name?.last].filter(Boolean).join(" "))
        });
      }
      CURRENT = out;
    })();

    // ---------- Civic API ----------
    function civicKey(){ return localStorage.getItem("GOOGLE_CIVIC_API_KEY") || ""; }
    function setKeyUI(){
      civicKeyEl.value = civicKey();
      keyState.textContent = civicKey() ? "● saved" : "not set";
    }
    setKeyUI();
    saveKeyBtn.onclick = ()=>{ localStorage.setItem("GOOGLE_CIVIC_API_KEY", civicKeyEl.value.trim()); setKeyUI(); };
    clearKeyBtn.onclick = ()=>{ localStorage.removeItem("GOOGLE_CIVIC_API_KEY"); setKeyUI(); };

    async function fetchCivic(address){
      const key = civicKey();
      if (!key) throw new Error("No Civic API key set. Paste it above and click Save.");
      const params = new URLSearchParams({
        address,
        levels: "country",
        roles: "legislatorUpperBody,legislatorLowerBody",
        key
      });
      const url = `https://civicinfo.googleapis.com/civicinfo/v2/representatives?${params.toString()}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error("Civic API error: "+r.status);
      return r.json();
    }

    function parseDivision(divId){
      // e.g., "ocd-division/country:us/state:az/cd:1"
      const mState = divId.match(/state:([a-z]{2})/i);
      const mCd = divId.match(/cd:(\d+)/i);
      return {
        state: mState ? mState[1].toUpperCase() : "",
        district: mCd ? mCd[1] : ""
      };
    }

    function matchToBioguide(name, division, chamberGuess){
      // Prefer exact state & district match; fall back to name+state
      const norm = normalizeName(name);
      const state = division.state;
      const district = division.district;
      let pool = CURRENT.filter(m => m.state===state && m.chamber===chamberGuess);
      if (chamberGuess==="house" && district) {
        const exact = pool.find(m => String(m.district) === String(district));
        if (exact) return exact;
      }
      // fallback: fuzzy by name within state & chamber
      const byName = pool.find(m => m.norm === norm) || pool.find(m => m.norm.includes(norm) || norm.includes(m.norm));
      if (byName) return byName;
      // last resort: any name match across all
      return CURRENT.find(m => m.norm === norm) || null;
    }

    function renderResults(people){
      res.innerHTML = "";
      if (!people.length) {
        res.appendChild(el("div",{class:"card"}, "No matches found."));
        return;
      }
      for (const p of people){
        const a = el("a",{href:`member.html?bioguide=${encodeURIComponent(p.bioguide)}`,"class":"btn"},"View report →");
        const img = el("img",{class:"portrait",src:IMG_URL(p.bioguide),alt:p.name});
        img.onerror = () => { img.style.visibility="hidden"; img.style.height="0"; };
        const seat = p.chamber==="senate" ? `(${p.state})` : `(${p.state}-${p.district?String(p.district).padStart(2,"0"):"AL"})`;
        const card = el("div",{class:"card"},[
          el("div",{class:"member"},[
            img,
            el("div",{},[
              el("div",{},[document.createTextNode(p.name+" "), (function(){const d=document.createElement("span"); d.innerHTML=partyPill(p.party); return d;})()]),
              el("div",{class:"dim"}, `${p.chamber==="senate"?"Senator":"Representative"} ${seat}`),
              a
            ])
          ])
        ]);
        res.appendChild(card);
      }
    }

    // ---------- Actions ----------
    goBtn.onclick = async () => {
      try {
        res.innerHTML = "";
        const address = addrEl.value.trim();
        if (!address) { alert("Enter an address."); return; }
        const data = await fetchCivic(address);
        const officials = data.officials || [];
        const offices = data.offices || [];
        const results = [];
        for (const office of offices){
          const div = parseDivision(office.divisionId||"");
          const isSen = (office.roles||[]).includes("legislatorUpperBody");
          const isRep = (office.roles||[]).includes("legislatorLowerBody");
          const chamber = isSen ? "senate" : isRep ? "house" : "";
          if (!chamber) continue;
          for (const idx of (office.officialIndices||[])){
            const off = officials[idx];
            if (!off) continue;
            const match = matchToBioguide(off.name, div, chamber);
            if (match) results.push(match);
          }
        }
        // Deduplicate by bioguide
        const uniq = Array.from(new Map(results.map(m=>[m.bioguide,m])).values());
        renderResults(uniq);
      } catch (e){
        res.innerHTML = "";
        res.appendChild(el("div",{class:"card"}, `Error: ${e.message}`));
      }
    };

    useLocBtn.onclick = () => {
      if (!navigator.geolocation) { alert("Geolocation not supported."); return; }
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const {latitude, longitude} = pos.coords;
        // Basic reverse geocode via Google Maps Geocoding API would require another key.
        alert("Paste your address manually for now (reverse geocoding not set up).");
      }, (err)=>{
        alert("Location error: "+err.message);
      });
    };
  </script>
</body>
</html>
